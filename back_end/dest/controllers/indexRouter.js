"use strict";var _regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var dbOperator=require("../models/dbOper.js"),upload=require("./uploadModel.js"),transMarkDown=require("../models/markdownTrans.js"),tokenUtil=require("../models/tokenUtil.js"),koaBody=require("koa-body"),initRouter={init:function(e,c){var t,n,a,o,s,i,u,g=this;e.post("/login",koaBody(),(t=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(r,t){var n,a,o;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n=r.request.body,a=void 0,"aaa"==n.name&&"aaa"==n.pwd?(o=tokenUtil.createToken(n.name,n.pwd),console.log(o),a={code:0,token:o}):a={code:404,token:null},r.body=a;case 4:case"end":return e.stop()}},e,g)})),function(e,r){return t.apply(this,arguments)})),e.post("/upload",tokenUtil.checkToken,upload.single("image"),(n=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(r,t){return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:r.body={filename:r.req.file.filename};case 1:case"end":return e.stop()}},e,g)})),function(e,r){return n.apply(this,arguments)})),e.post("/insert",koaBody(),tokenUtil.checkToken,(a=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(r,t){var n,a,o,c,s;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=r.request.body,a="articles",o="article",n.content){e.next=6;break}return r.body={code:400,result:"请输入内容"},e.abrupt("return");case 6:return c={content:n.content,date:n.date,type:n.type},e.next=9,dbOperator.insertArticle(r,a,o,c);case 9:s=e.sent,r.body={code:0,result:s.insertedCount};case 11:case"end":return e.stop()}},e,g)})),function(e,r){return a.apply(this,arguments)})),e.post("/update",koaBody(),tokenUtil.checkToken,(o=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(r,t){var n,a,o;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.request.body,"articles","article",a={content:n.content,date:n.date,type:n.type,uniqueKey:n.uniqueKey},e.next=6,dbOperator.updateArticle(c,r,"articles","article",a);case 6:o=e.sent,r.body={code:0,result:o.result.nModified};case 8:case"end":return e.stop()}},e,g)})),function(e,r){return o.apply(this,arguments)})),e.get("/getAllArticles/:currentPage/:size/:total",(s=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(r,t){var n,a,o,c,s,i,u,l,d,p,f,y,k;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.params,"articles","article",a=n.currentPage||1,o=n.size||10,c=0==n.total,e.next=8,dbOperator.getAllArticle(r,"articles","article",a,o,c);case 8:if(s=e.sent,i={},!s){e.next=30;break}for(l=!(u=!0),d=void 0,e.prev=14,p=s[Symbol.iterator]();!(u=(f=p.next()).done);u=!0)null!=(y=f.value)&&(k=transMarkDown(y.content).substring(0,200),Object.assign(y,{content:k}));e.next=22;break;case 18:e.prev=18,e.t0=e.catch(14),l=!0,d=e.t0;case 22:e.prev=22,e.prev=23,!u&&p.return&&p.return();case 25:if(e.prev=25,!l){e.next=28;break}throw d;case 28:return e.finish(25);case 29:return e.finish(22);case 30:Object.assign(i,s),i.code=0,r.body=i;case 33:case"end":return e.stop()}},e,g,[[14,18,22,30],[23,,25,29]])})),function(e,r){return s.apply(this,arguments)})),e.get("/getArticleByID/:id",(i=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(r,t){var n,a,o;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.params,"articles","article",a=n.id,e.next=6,dbOperator.getArticleByID(c,r,"articles","article",a);case 6:(o=e.sent)&&(r.body={code:0,res:o});case 8:case"end":return e.stop()}},e,g)})),function(e,r){return i.apply(this,arguments)})),e.get("/delArticle/:id",tokenUtil.checkToken,(u=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(r,t){var n,a,o;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.params,"articles","article",a=n.id,e.next=6,dbOperator.delArticle(c,r,"articles","article",a);case 6:o=e.sent,console.log(o),o&&(r.body={code:0,result:o});case 9:case"end":return e.stop()}},e,g)})),function(e,r){return u.apply(this,arguments)}))}};module.exports=initRouter;